/*@license Copyright 2015-2022 Ably Real-time Ltd (ably.com)

Ably JavaScript Library v2.4.1
https://github.com/ably/ably-js

Released under the Apache Licence v2.0*/(function (g, f) {
    if ("object" == typeof exports && "object" == typeof module) {
      module.exports = f();
    } else if ("function" == typeof define && define.amd) {
      define([], f);
    } else if ("object" == typeof exports) {
      exports["AblyPushPlugin"] = f();
    } else {
      g["AblyPushPlugin"] = f();
    }
  }(this, () => {
var exports = {};
var module = { exports };
"use strict";var R=Object.defineProperty,tt=Object.defineProperties,et=Object.getOwnPropertyDescriptor,nt=Object.getOwnPropertyDescriptors,rt=Object.getOwnPropertyNames,J=Object.getOwnPropertySymbols;var _=Object.prototype.hasOwnProperty,it=Object.prototype.propertyIsEnumerable;var H=(r,t,e)=>t in r?R(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,q=(r,t)=>{for(var e in t||(t={}))_.call(t,e)&&H(r,e,t[e]);if(J)for(var e of J(t))it.call(t,e)&&H(r,e,t[e]);return r},z=(r,t)=>tt(r,nt(t));var ot=(r,t)=>()=>(t||r((t={exports:{}}).exports,t),t.exports),st=(r,t)=>{for(var e in t)R(r,e,{get:t[e],enumerable:!0})},at=(r,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of rt(t))!_.call(r,i)&&i!==e&&R(r,i,{get:()=>t[i],enumerable:!(n=et(t,i))||n.enumerable});return r};var ct=r=>at(R({},"__esModule",{value:!0}),r);var X=ot(()=>{});var Et={};st(Et,{ActivationStateMachine:()=>C,CalledActivate:()=>a,CalledDeactivate:()=>u,PushChannel:()=>N,default:()=>Ct,getW3CPushDeviceDetails:()=>w,localDeviceFactory:()=>j});module.exports=ct(Et);var L=class{constructor(t){this.channel=t,this.client=t.client}async subscribeDevice(){let t=this.client,e=t.device,n=t.options.useBinaryProtocol?t.Utils.Format.msgpack:t.Utils.Format.json,i={deviceId:e.id,channel:this.channel.name},o=t.Defaults.defaultPostHeaders(t.options,{format:n});t.options.headers&&t.Utils.mixin(o,t.options.headers),t.Utils.mixin(o,this._getPushAuthHeaders());let s=t.Utils.encodeBody(i,t._MsgPack,n);await t.rest.Resource.post(t,"/push/channelSubscriptions",s,o,{},n,!0)}async unsubscribeDevice(){let t=this.client,e=t.device,n=t.options.useBinaryProtocol?t.Utils.Format.msgpack:t.Utils.Format.json,i=t.Defaults.defaultPostHeaders(t.options,{format:n});t.options.headers&&t.Utils.mixin(i,t.options.headers),t.Utils.mixin(i,this._getPushAuthHeaders()),await t.rest.Resource.delete(t,"/push/channelSubscriptions",i,{deviceId:e.id,channel:this.channel.name},n,!0)}async subscribeClient(){let t=this.client,e=this.client.auth.clientId;if(!e)throw new this.client.ErrorInfo("Cannot subscribe from client without client ID",5e4,500);let n=t.options.useBinaryProtocol?t.Utils.Format.msgpack:t.Utils.Format.json,i={clientId:e,channel:this.channel.name},o=t.Defaults.defaultPostHeaders(t.options,{format:n});t.options.headers&&t.Utils.mixin(o,t.options.headers);let s=t.Utils.encodeBody(i,t._MsgPack,n);await t.rest.Resource.post(t,"/push/channelSubscriptions",s,o,{},n,!0)}async unsubscribeClient(){let t=this.client,e=this.client.auth.clientId;if(!e)throw new this.client.ErrorInfo("Cannot unsubscribe from client without client ID",5e4,500);let n=t.options.useBinaryProtocol?t.Utils.Format.msgpack:t.Utils.Format.json,i=t.Defaults.defaultPostHeaders(t.options,{format:n});t.options.headers&&t.Utils.mixin(i,t.options.headers),await t.rest.Resource.delete(t,"/push/channelSubscriptions",i,{clientId:e,channel:this.channel.name},n,!0)}async listSubscriptions(t){return this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_MICRO,"PushChannel.listSubscriptions()","channel = "+this.channel.name),this.client.push.admin.channelSubscriptions.list(z(q({},t),{channel:this.channel.name,concatFilters:!0}))}_getDeviceIdentityToken(){let e=this.client.device.deviceIdentityToken;if(e)return e;throw new this.client.ErrorInfo("Cannot subscribe from client without deviceIdentityToken",5e4,500)}_getPushAuthHeaders(){return{"X-Ably-DeviceToken":this._getDeviceIdentityToken()}}},N=L;function Q(r){let t=new Uint8Array(r.slice(0,r.byteLength));return btoa(String.fromCharCode.apply(null,Array.from(t)))}function lt(r){let t="=".repeat((4-r.length%4)%4);return(r+t).replace(/-/g,"+").replace(/_/g,"/")}function ut(r){let t=window.atob(r),e=[];for(let n=0;n<t.length;n++)e.push(t[n].charCodeAt(0));return Uint8Array.from(e)}async function w(r){let t=r.GettingPushDeviceDetailsFailed,e=r.GotPushDeviceDetails,{ErrorInfo:n,Defaults:i}=r.client;if(await Notification.requestPermission()!=="granted"){r.handleEvent(new t(new n("User denied permission to send notifications",400,4e4)));return}let s=r.client.options.pushServiceWorkerUrl;if(!s){r.handleEvent(new t(new n("Missing ClientOptions.pushServiceWorkerUrl",400,4e4)));return}try{let c=await navigator.serviceWorker.register(s);r._pushManager=c.pushManager;let g=i.defaultGetHeaders(r.client.options,{format:"text"}),p=(await r.client.rest.Resource.get(r.client,"/push/publicVapidKey",g,{},null,!0)).body;c.active||await navigator.serviceWorker.ready;let f=await c.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:ut(lt(p))}),M=f.endpoint,[K,G]=[f.getKey("p256dh"),f.getKey("auth")];if(!K||!G)throw new n("Public key not found",5e4,500);let V=r.client.device;V.push.recipient={transportType:"web",targetUrl:btoa(M),publicVapidKey:p,encryptionKey:{p256dh:Q(K),auth:Q(G)}},V.persist(),r.handleEvent(new e)}catch(c){r.handleEvent(new t(new n("Failed to register service worker",5e4,500,c)))}}function S(r){var t=new Error(r);return t.source="ulid",t}var F="0123456789ABCDEFGHJKMNPQRSTVWXYZ",I=F.length,$=Math.pow(2,48)-1,ft=10,dt=16;function pt(r){var t=Math.floor(r()*I);return t===I&&(t=I-1),F.charAt(t)}function ht(r,t){if(isNaN(r))throw new Error(r+" must be a number");if(r>$)throw S("cannot encode time greater than "+$);if(r<0)throw S("time must be positive");if(Number.isInteger(r)===!1)throw S("time must be an integer");for(var e=void 0,n="";t>0;t--)e=r%I,n=F.charAt(e)+n,r=(r-e)/I;return n}function gt(r,t){for(var e="";r>0;r--)e=pt(t)+e;return e}function mt(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=arguments[1];t||(t=typeof window!="undefined"?window:null);var e=t&&(t.crypto||t.msCrypto);if(e)return function(){var i=new Uint8Array(1);return e.getRandomValues(i),i[0]/255};try{var n=X();return function(){return n.randomBytes(1).readUInt8()/255}}catch(i){}if(r){try{console.error("secure crypto unusable, falling back to insecure Math.random()!")}catch(i){}return function(){return Math.random()}}throw S("secure crypto unusable, insecure Math.random not allowed")}function vt(r){return r||(r=mt()),function(e){return isNaN(e)&&(e=Date.now()),ht(e,ft)+gt(dt,r)}}var W=vt();var l={deviceId:"ably.push.deviceId",deviceSecret:"ably.push.deviceSecret",deviceIdentityToken:"ably.push.deviceIdentityToken",pushRecipient:"ably.push.pushRecipient",activationState:"ably.push.activationState"};function j(r){return class Z extends r{constructor(n){super();this.push={},this.rest=n}static load(n){let i=new Z(n);return i.loadPersisted(),i}loadPersisted(){var i;let n=this.rest.Platform;if(!n.Config.push)throw new this.rest.ErrorInfo("Push activation is not available on this platform",4e4,400);this.platform=n.Config.push.platform,this.clientId=(i=this.rest.auth.clientId)!=null?i:void 0,this.formFactor=n.Config.push.formFactor,this.id=n.Config.push.storage.get(l.deviceId),this.id?(this.deviceSecret=n.Config.push.storage.get(l.deviceSecret)||void 0,this.deviceIdentityToken=JSON.parse(n.Config.push.storage.get(l.deviceIdentityToken)||"null"),this.push.recipient=JSON.parse(n.Config.push.storage.get(l.pushRecipient)||"null")):this.resetId()}persist(){let n=this.rest.Platform.Config;if(!n.push)throw new this.rest.ErrorInfo("Push activation is not available on this platform",4e4,400);this.id&&n.push.storage.set(l.deviceId,this.id),this.deviceSecret&&n.push.storage.set(l.deviceSecret,this.deviceSecret),this.deviceIdentityToken&&n.push.storage.set(l.deviceIdentityToken,JSON.stringify(this.deviceIdentityToken)),this.push.recipient&&n.push.storage.set(l.pushRecipient,JSON.stringify(this.push.recipient))}resetId(){this.id=W(),this.deviceSecret=W(),this.persist()}getAuthDetails(n,i,o){if(!this.deviceIdentityToken)throw new this.rest.ErrorInfo("Unable to update device registration; no deviceIdentityToken",5e4,500);return this.rest.http.supportsAuthHeaders?{headers:n.Utils.mixin({authorization:"Bearer "+n.Utils.toBase64(this.deviceIdentityToken)},i),params:o}:{headers:i,params:n.Utils.mixin({access_token:this.deviceIdentityToken},o)}}}}var C=class{constructor(t){this.GettingPushDeviceDetailsFailed=E;this.GotPushDeviceDetails=h;this.client=t,this._pushConfig=t.Platform.Config.push,this.current=new wt[this.pushConfig.storage.get(l.activationState)||"NotActivated"](null),this.pendingEvents=[],this.handling=!1}get pushConfig(){if(!this._pushConfig)throw new this.client.ErrorInfo("This platform is not supported as a target of push notifications",4e4,400);return this._pushConfig}persist(){It(this.current)&&this.pushConfig.storage.set(l.activationState,this.current.name)}callUpdateRegistrationFailedCallback(t){this.updateFailedCallback?this.updateFailedCallback(t):this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_ERROR,"UpdateRegistrationFailed","Failed updating device push registration: "+this.client.Utils.inspectError(t))}callCustomRegisterer(t,e){var n;(n=this.registerCallback)==null||n.call(this,t,(i,o)=>{if(i){e?this.handleEvent(new m(i)):this.handleEvent(new k(i));return}o||this.handleEvent(new m(new this.client.ErrorInfo("registerCallback did not return deviceRegistration",4e4,400))),e?this.handleEvent(new y(o)):this.handleEvent(new T)})}callCustomDeregisterer(t){var e;(e=this.deregisterCallback)==null||e.call(this,t,n=>{if(n){this.handleEvent(new A(n));return}this.handleEvent(new D)})}async updateRegistration(){let t=this.client.device;if(this.registerCallback)this.callCustomRegisterer(t,!1);else{let e=this.client,n=e.options.useBinaryProtocol?this.client.Utils.Format.msgpack:this.client.Utils.Format.json,i=e.rest.DeviceDetails.fromLocalDevice(t),o=this.client.Defaults.defaultPostHeaders(this.client.options,{format:n}),s={};e.options.headers&&this.client.Utils.mixin(o,e.options.headers),e.options.pushFullWait&&this.client.Utils.mixin(s,{fullWait:"true"});let c=this.client.Utils.encodeBody(i,e._MsgPack,n),g=t.getAuthDetails(e,o,s);try{let p=await this.client.rest.Resource.patch(e,"/push/deviceRegistrations",c,g.headers,g.params,n,!0);this.handleEvent(new y(p.body))}catch(p){this.handleEvent(new m(p))}}}async deregister(){let t=this.client.device;if(this.deregisterCallback)this.callCustomDeregisterer(t);else{let e=this.client,n=e.options.useBinaryProtocol?this.client.Utils.Format.msgpack:this.client.Utils.Format.json,i=this.client.Defaults.defaultPostHeaders(e.options,{format:n}),o={deviceId:t.id};e.options.headers&&this.client.Utils.mixin(i,e.options.headers),e.options.pushFullWait&&this.client.Utils.mixin(o,{fullWait:"true"});try{await this.client.rest.Resource.delete(e,"/push/deviceRegistrations",i,o,n,!0),this.handleEvent(new D)}catch(s){this.handleEvent(new A(s))}}}callActivatedCallback(t){var e;(e=this.activatedCallback)==null||e.call(this,t),delete this.activatedCallback}callDeactivatedCallback(t){var e;(e=this.deactivatedCallback)==null||e.call(this,t),delete this.deactivatedCallback}handleEvent(t){if(this.handling){this.client.Platform.Config.nextTick(()=>{this.handleEvent(t)});return}this.handling=!0,this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_MAJOR,"Push.ActivationStateMachine.handleEvent()","handling event "+t.name+" from "+this.current.name);let e=this.current.processEvent(this,t);if(!e){this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_MAJOR,"Push.ActivationStateMachine.handleEvent()","enqueing event: "+t.name),this.pendingEvents.push(t),this.handling=!1;return}for(this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_MAJOR,"Push.ActivationStateMachine.handleEvent()","transition: "+this.current.name+" -("+t.name+")-> "+e.name),this.current=e;this.pendingEvents.length>0;){let n=this.pendingEvents[0];if(this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_MAJOR,"Push.ActivationStateMachine.handleEvent()","attempting to consume pending event: "+n.name),e=this.current.processEvent(this,n),!e)break;this.pendingEvents.splice(0,1),this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_MAJOR,"Push.ActivationStateMachine.handleEvent()","transition: "+this.current.name+" -("+n.name+")-> "+e.name),this.current=e}this.persist(),this.handling=!1}},a=class{constructor(t,e){this.name="CalledActivate";e&&(t.registerCallback=e),t.persist()}},u=class{constructor(t,e){this.name="CalledDeactivate";t.deregisterCallback=e,t.persist()}},h=class{constructor(){this.name="GotPushDeviceDetails"}},E=class{constructor(t){this.name="GettingPushDeviceDetailsFailed";this.reason=t}},y=class{constructor(t){this.name="GotDeviceRegistration";this.tokenDetails=t.deviceIdentityToken}},m=class{constructor(t){this.name="GettingDeviceRegistrationFailed";this.reason=t}},T=class{constructor(){this.name="RegistrationSynced"}},k=class{constructor(t){this.name="SyncRegistrationFailed";this.reason=t}},D=class{constructor(){this.name="Deregistered"}},A=class{constructor(t){this.name="DeregistrationFailed";this.reason=t}},d=class{constructor(t){this.name=t}},v=class r extends d{constructor(){super("NotActivated")}processEvent(t,e){var n,i;if(e instanceof u)return t.callDeactivatedCallback(null),new r;if(e instanceof a){let o=t.client.device;return o.deviceIdentityToken!=null?o.clientId&&o.clientId!==t.client.auth.clientId?(t.handleEvent(new k(new t.client.ErrorInfo("clientId not compatible with local device clientId",61002,400))),null):(t.pendingEvents.push(e),new b):(o.push.recipient?t.pendingEvents.push(new h):t.pushConfig.getPushDeviceDetails?(i=(n=t.pushConfig).getPushDeviceDetails)==null||i.call(n,t):t.pushConfig.platform==="browser"?w(t):t.handleEvent(new E(new t.client.ErrorInfo("No available implementation to get push device details",5e4,500))),new U)}else if(e instanceof h)return new r;return null}},U=class r extends d{constructor(){super("WaitingForPushDeviceDetails")}processEvent(t,e){if(e instanceof a)return new r;if(e instanceof u)return t.callDeactivatedCallback(null),new v;if(e instanceof h){let n=t.client,i=n.device;if(t.registerCallback)t.callCustomRegisterer(i,!0);else{let o=n.options.useBinaryProtocol?t.client.Utils.Format.msgpack:t.client.Utils.Format.json,s=n.rest.DeviceDetails.fromLocalDevice(i),c=t.client.Defaults.defaultPostHeaders(n.options,{format:o}),g={};n.options.headers&&t.client.Utils.mixin(c,n.options.headers),n.options.pushFullWait&&t.client.Utils.mixin(g,{fullWait:"true"});let p=t.client.Utils.encodeBody(s,n._MsgPack,o);t.client.rest.Resource.post(n,"/push/deviceRegistrations",p,c,g,null,!0).then(f=>{let M=f.unpacked?f.body:n.rest.DeviceDetails.fromResponseBody(f.body,n._MsgPack,o);t.handleEvent(new y(M))}).catch(f=>{t.handleEvent(new m(f))})}return new B}else if(e instanceof E)return t.callActivatedCallback(e.reason),new v;return null}},B=class r extends d{constructor(){super("WaitingForDeviceRegistration")}processEvent(t,e){if(e instanceof a)return new r;if(e instanceof y){let n=t.client.device;return n.deviceIdentityToken=e.tokenDetails.token,n.persist(),t.callActivatedCallback(null),new b}else if(e instanceof m)return t.callActivatedCallback(e.reason),new v;return null}},b=class r extends d{constructor(){super("WaitingForNewPushDeviceDetails")}processEvent(t,e){return e instanceof a?(t.callActivatedCallback(null),new r):e instanceof u?(t.deregister(),new x(this)):e instanceof h?(t.updateRegistration(),new P):null}},P=class r extends d{constructor(e=!1){super("WaitingForRegistrationSync");this.triggeredByCalledActivate=e}processEvent(e,n){return n instanceof a&&!this.triggeredByCalledActivate?(e.callActivatedCallback(null),new r(!0)):n instanceof T?new b:n instanceof k?(e.callUpdateRegistrationFailedCallback(n.reason),new O):null}},O=class extends d{constructor(){super("AfterRegistrationSyncFailed")}processEvent(t,e){return e instanceof a||e instanceof h?(t.updateRegistration(),new P(e instanceof a)):e instanceof u?(t.deregister(),new x(this)):null}},x=class r extends d{constructor(e){super("WaitingForDeregistration");this.previousState=e}processEvent(e,n){if(n instanceof u)return new r(this.previousState);if(n instanceof D){let i=e.client.device;return delete i.deviceIdentityToken,delete i.push.recipient,i.resetId(),i.persist(),e.callDeactivatedCallback(null),new v}else if(n instanceof A)return e.callDeactivatedCallback(n.reason),this.previousState;return null}},wt={NotActivated:v,WaitingForPushDeviceDetails:U,WaitingForDeviceRegistration:B,WaitingForNewPushDeviceDetails:b,WaitingForRegistrationSync:P,AfterRegistrationSyncFailed:O,WaitingForDeregistration:x};function It(r){return r.name=="NotActivated"||r.name=="WaitingForNewPushDeviceDetails"}var Ct={ActivationStateMachine:C,localDeviceFactory:j,CalledActivate:a,CalledDeactivate:u,PushChannel:N,getW3CPushDeviceDetails:w};
if (typeof module.exports == "object" && typeof exports == "object") {
  var __cp = (to, from, except, desc) => {
    if ((from && typeof from === "object") || typeof from === "function") {
      for (let key of Object.getOwnPropertyNames(from)) {
        if (!Object.prototype.hasOwnProperty.call(to, key) && key !== except)
        Object.defineProperty(to, key, {
          get: () => from[key],
          enumerable: !(desc = Object.getOwnPropertyDescriptor(from, key)) || desc.enumerable,
        });
      }
    }
    return to;
  };
  module.exports = __cp(module.exports, exports);
}
return module.exports;
}))
//# sourceMappingURL=push.umd.min.js.map
